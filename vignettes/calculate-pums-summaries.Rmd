---
title: "Calculate PUMS summaries"
description: >
  Learn how to utilize Census microdata to go beyond Census-published statistics
output: html_vignette
vignette: >
  %\VignetteIndexEntry{Calculate PUMS summaries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
library(psrccensus)
library(magrittr)
```

## What is Census microdata?

Along with publishing summary statistics from the diennial Census or American Community Survey (ACS), the Census Bureau also makes available a subset of individual person and housing (incl. household) records, called the Public Use Microdata Sample (PUMS). These can be used to estimate models or to tabulate custom statistics unavailable in Census-published summary statistics. Partly to safeguard privacy, PUMS data is not categorized by standard Census geographies such as block, block group or tract; instead the unit is the Public Use Microdata Area (PUMA), an aggregation of tracts with total population between 100,000-200,000. In the past there were more that one set of PUMAs, corresponding to different sampling rates; that is no longer the case (PUMAs now consistently represent a 5 percent sample).

PUMS data include sampling weights in order to be extrapolated to a larger population, and replication weights in order to calculate margins of error. When PUMS is used to drill down to small subsets of the population, particular attention should be paid to the margins of error in drawing any conclusions from the data. The Census Bureau resource [What ACS Public Use Microdata Sample File Users Need to Know]( https://www.census.gov/programs-surveys/acs/guidance/handbooks/pums.html) is a helpful resource if you have further questions about PUMS itself.

## Summary statistics via psrccensus

The PSRC census package makes it easy to calculate standard summary statistics by county or for the region as a whole. Data analysis with the psrccensus package involves two steps:

The first step consists of retrieving the data of interest via the **get_psrc_pums()** function. The arguments are:
   **span**  - either 1 or 5, denoting the span of the desired ACS survey
   **dyear** - aka data year or concluding year for 5-yr ACS
   **level** - the unit of analysis, i.e. "p" for "persons" or "h" for "households"
   **vars**  - one or more PUMS variables (e.g. list), quoted exactly, in uppercase
The PUMS data dictionary is captured in the object **tidycensus::pums_variables** (filter by year and survey). The Census Bureau also publishes each separate data dictionary online, [2015-19 as an example](https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMS_Data_Dictionary_2015-2019.pdf).

PUMS has two distinct units of analysis: persons ("persons" table), or households ("housing" table). You must call get_psrc_pums() specific to the unit of analysis at hand, as household-level datasets do not contain persons living in group quarters and person-level datasets are not filtered to households. (Household datasets are further filtered to remove vacant units.) A person-level dataset can include household-level attributes, and per Census Bureau conventions, a household-level dataset can contain the person-level attributes of the adult respondent (aka "householder; this is also true of published American Community Survey estimates). 

Because the ACS (from which the PUMS records are developed) is a rolling survey, responses are collected at different times throughout the year and the value of money may have changed slightly during that time. Published ACS estimates have a 'baked-in' inflation adjustment (derived from the Federal Consumer Price Index, or CPI) to account for this. Dollar amounts in the PUMS dataset, however, are provided raw--as they were reported--along with an average inflation adjustment factor. If you prefer your estimates exclude this adjustment, add the argument `dollar_adj = FALSE`.

The result of **get_psrc_pums()** is a structured data object (per the srvyr package) that has sampling and replication weights built in. The analysis and grouping variables are stored in a dataframe as the seventh item in the list. Srvyr objects can be manipulated using dplyr syntax if necessary, although that is not required while using psrccensus (see [its vignette] (http://gdfe.co/srvyr/)).

The second step involves calculating summary statistics from the result of the prior step. There are eight separate functions: four statistics, specific either to the region as a whole, or by county.

  regional               county
  --------------------   -------------------
  psrc_pums_total()      county_pums_total()
  psrc_pums_count()      county_pums_count()
  psrc_pums_median()     county_pums_median()
  psrc_pums_mean()       county_pums_mean()

The first argument of each function is the srvyr object returned by get_psrc_pums, which facilitates chaining (e.g. via magrittr pipe). For total, median and mean functions, the second argument is the variable to be summarized; for count, this is implicit. Finally, there is an optional argument for grouping variables, which can be a list of more than one. psrccensus does not constrain your choice of variables, but clearly any variable to be summarized must be a number, and grouping variables should not be continuous.

Since PUMS records are survey records, sampling weights are applied to deliver estimates of the full population. Margins of error are tabulated along with the estimate and supplied in a separate column. 

To calculate the regional median age for 2019, for example, you would use the following function call:
```{r regional median, message=FALSE, eval=FALSE}
get_psrc_pums(span = 1,             # Denoting ACS 1-year estimates
              dyear = 2019,
              level = "p",          # Unit of analysis == person
              vars = "AGEP") %>%    # The PUMS variable name for household income
  psrc_pums_median("AGEP")          # Only second argument is necessary (chaining)
```

To calculate by a subgroup category (here, housing tenure--e.g. own vs. rent), use the optional grouping variable argument:
```{r regional median by category, message=FALSE, eval=FALSE}
ni <- get_psrc_pums(span = 5,                    # Denoting ACS 5-year estimates
                    dyear = 2019,
                    level = "h"      ,           # Unit of analysis == household
                    vars = c("HINCP","TEN"))     # The PUMS household income & housing tenure variables
psrc_pums_median(ni, "HINCP", "TEN")             # Median household income grouped by tenure
```

For the equivalent calculation by county, use the county-specific function:
```{r county median by category, message=FALSE, eval=FALSE}
county_pums_median(ni, "HINCP", "TEN")           # Srvyr object can be used repeatedly for calculation

```

The count functions tabulate the number people or households by grouping category. The result represents the population (via weighting), not the survey sample.
```{r county count by category, message=FALSE, eval=FALSE}
county_pums_count(ni, "TEN")                     # Second argument is grouping variable; primary variable is implicit
```

If you intend to count things other than people or households, such as number of bedrooms, you should use the 'total' functions instead, which sum the target variable.

All results are limited to the 4-county PSRC region for simplicity, although the underlying data exists for every part of the country. 

At present the Census Microdata API is limited to data years 2017 and later. The API also routinely experiences unexplained downtime between 2-7pm Pacific Time, returning in place of data the message
  *Your API call has errors. The API message returned is There was an error while running your query. We've logged the error and we'll correct it ASAP. Sorry for the inconvenience.* 
-or- 
  *"Sorry, the system is currently undergoing maintenance or is busy.  Please try again later."*
For earlier data years, or when the API is down, it is possible to download raw PUMS from the [Census FTP server](https://www2.census.gov/programs-surveys/acs/data/pums/). 
