---
title: "Calculate PUMS summaries"
description: >
  Learn how to utilize Census microdata to go beyond Census-published statistics
output: html_vignette
vignette: >
  %\VignetteIndexEntry{Calculate PUMS summaries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(psrccensus)
library(dplyr)
```

## What is Census microdata?

Along with publishing summary statistics from the diennial Census or American Community Survey (ACS), the Census Bureau also makes available a subset of individual person and housing (incl. household) records, called the Public Use Microdata Sample (PUMS). These can be used to estimate models or to tabulate custom statistics unavailable in Census-published summary statistics. Partly to safeguard privacy, PUMS data is not categorized by standard Census geographies such as block, block group or tract; instead the unit is the Public Use Microdata Area (PUMA), an aggregation of tracts with total population between 100,000-200,000. In the past there were more that one set of PUMAs, corresponding to different sampling; that is no longer the case (PUMAs now consistently represent a 5 percent sample).

PUMS data include sampling weights in order to be extrapolated to a larger population, and 80 replication weights in order to calculate margins of error. When PUMS is used to drill down to small subsets of the population, particular attention should be paid to the margins of error in drawing any conclusions from the data.

## Summary statistics via psrccensus

The PSRC census package makes it easy to calculate standard summary statistics by county or for the region as a whole, using the following functions, specific to geography and the desired statistic:

      Regional               County     
-------------------- --------------------
psrc_pums_total()    county_pums_total()
psrc_pums_count()    county_pums_count()
psrc_pums_median()   county_pums_median()
psrc_pums_mean()     county_pums_mean()
psrc_pums_ratio()    county_pums_ratio()
-------------------- --------------------

Each function requires three arguments: the first two denote the dataset involved; the third is the PUMS variable name you wish to summarize. To separate that statistic for subgroups of the population, use the optional fourth argument (for the ratio statistic, this serves as the denominator instead). You must enter the exact target variable or grouping variable name (in uppercase), and since these names vary from the diennial or acs naming, it may be useful to reference the data dictionaries the Census Bureau provides specific to each data year, [2020 as an example]( https://www.census.gov/programs-surveys/acs/data/experimental-data/2020-1-year-pums.html).

The functions handle extrapolation to the wider population (via sampling weights) and calculation of margins of error (via replication weights) internally. Additionally, they also apply inflation adjustments to variables measured in dollar values: since the survey is collected on a rolling basis, nominal income components or costs would not otherwise be directly comparable between households.

To calculate the regional median household income for 2019, for example, you would use the following function call:
```{r pums examples, message=FALSE}
psrc_pums_median(span = 1,                  # Denoting ACS 1-year estimates
                 dyear = 2019,
                 target_var = "HINCP")      # The PUMS variable name for Household Income

```

To calculate regional median household income by detailed racial group, the call would look like this:
```{r pums examples, message=FALSE}
psrc_pums_median(span = 1,                  # Denoting ACS 1-year estimates
                 dyear = 2019,
                 target_var = "HINCP",      # The PUMS variable name for Household Income
                 group_var = "RAC1P")       # The higher-level race category available in PUMS   
```

Results are limited to the 4-county PSRC region for simplicity, although the underlying data exists for every part of the country.

Development is underway to enable custom grouping categories using the same functions.

## Considerations with the PUMS API

Due to the volume of data being transferred via API (particularly the replication weights), a PUMS function call may take around a full minute to execute. The functions still represent a time savings over manual calculations, so feel free to get a snack or stretch while the function runs. 8^)

**Please notice**: The Census Bureau PUMS API routinely has downtime between 2-5pm Pacific Time. Do not be alarmed if you receive one of the following messages:
*Your API call has errors. The API message returned is There was an error while running your query. We've logged the error and we'll correct it ASAP. Sorry for the inconvenience.* -or-   *"Sorry, the system is currently undergoing maintenance or is busy.  Please try again later."*
In light of this, we suggest scheduling work with PUMS earlier in the workday, or waiting until the API has been restored. (PUMS data can still be downloaded from the [Census FTP server](https://www2.census.gov/programs-surveys/acs/data/pums/), but without the automation included in psrccensus.)

## Complete microdata series via psrccensus

The functions above provide the most accessible way to develop county and regional estimates, but when you need the underlying microdata, psrccensus provides that option via the get_psrc_pums() function. psrccensus uses the [srvyr package](http://gdfe.co/srvyr/) for PUMS analysis, and get_psrc_pums() returns a srvyr object specific to the PSRC region with sampling and replication weights built in and all the inflation adjustments already applied. Specific srvyr methods are necessary to analyze srvyr objects, but they are generally analogous to base R equivalents and can be manipulated using dplyr commands. (If the object is converted to a dataframe, the weights will be lost.)

The syntax for get_psrc_pums() is the same as the functions listed above:

get_psrc_pums(span = 1, 
              dyear= 2019, 
              target_var = "HINCP", 
              group_var = "RAC1P")
              
Along with the target variable and optional grouping variable, get_psrc_pums() also returns the unit identifier (SERIALNO for household; SERIALNO and SPORDER for person), county name and PUMA code. 

