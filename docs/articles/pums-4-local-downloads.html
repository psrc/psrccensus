<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Switch to a local source to speed up repeated PUMS survey calls
">
<title>PUMS 4: Download optimization • psrccensus</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="PUMS 4: Download optimization">
<meta property="og:description" content="Switch to a local source to speed up repeated PUMS survey calls
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psrccensus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/psrccensus.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/calculate-reliability-moe-transformed-acs.html">Reliability Measures for ACS data tables</a>
    <a class="dropdown-item" href="../articles/geographic-conversions.html">Census estimates for non-census geographies</a>
    <a class="dropdown-item" href="../articles/get-data.html">Get Data</a>
    <a class="dropdown-item" href="../articles/pums-1-basics.html">PUMS 1: Calculate basic summaries</a>
    <a class="dropdown-item" href="../articles/pums-2-make-vars.html">PUMS 2: Make your own variables</a>
    <a class="dropdown-item" href="../articles/pums-3-multiyear.html">PUMS 3: Script multiyear functions</a>
    <a class="dropdown-item" href="../articles/pums-4-local-downloads.html">PUMS 4: Download optimization</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>PUMS 4: Download optimization</h1>
            
      
      
      <div class="d-none name"><code>pums-4-local-downloads.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="under-the-hood-sources-for-pums-microdata">Under the hood: sources for PUMS microdata<a class="anchor" aria-label="anchor" href="#under-the-hood-sources-for-pums-microdata"></a>
</h2>
<p>By default, the <code><a href="../reference/get_psrc_pums.html">psrccensus::get_psrc_pums()</a></code> function
downloads microdata for the entire state from the Census FTP site.
Because each call to <code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code> can retrieve variables
from the household and person datasets, it downloads both–which can take
around a minute for 5-yr surveys, depending on the internet connection.
(An earlier build pulled only requested variables via the Census API,
but package authors found it slower than the FTP approach, and subject
to unexplained, almost daily downtimes after 5pm Eastern time.)</p>
</div>
<div class="section level2">
<h2 id="strategies-to-minimize-downloads">Strategies to minimize downloads<a class="anchor" aria-label="anchor" href="#strategies-to-minimize-downloads"></a>
</h2>
<p>One way to minimize download time is to reduce separate calls to
<code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code>, requesting all variables you need for a
given span-year-level combination in one set. This also reduces memory
loads. Related efficiency hints include <a href="pums-3-multiyear.html#hint-4---minimize-downloads">batching
multiyear analysis by year rather than by variable</a> and summarizing
with the <a href="pums-2-make-vars.html#handle-subsets-via-a-universal-variable-the-incl_nafalse-option"><code>incl_na=FALSE</code>
option</a> instead of creating multiple filtered objects.</p>
</div>
<div class="section level2">
<h2 id="shift-to-local-files-using-dir">Shift to local files using <code>dir=</code><a class="anchor" aria-label="anchor" href="#shift-to-local-files-using-dir"></a>
</h2>
<p>You can also skip the download altogether by loading prepared
household and person tables stored locally. This shortcut is activated
by specifying the directory in which to find the data in the
<code>dir=</code> argument to <code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code>. The data
must be stored as gzip-compressed .rds files with a specific naming
convention–concatenated data year, level, and span; e.g. “2022h1.gz” or
“2017p5.gz” (for PSRC staff, these files already exist on the network;
see the PSRC Data wiki entry, “Working_with_PUMS_data”.)</p>
<div class="section level3">
<h3 id="create-the-local-file">Create the local file<a class="anchor" aria-label="anchor" href="#create-the-local-file"></a>
</h3>
<pre class="make"><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">pums_rds</span> <span class="op">&lt;-</span> <span class="st">"your/desired/storage/directory/path"</span> <span class="co"># Specify your directory, or change your working directory to the storage location</span></span>
<span></span>
<span><span class="va">make_offline_pums</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">yr_lv_sp</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">yr_lv_sp</span>, <span class="fl">1L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">level</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">yr_lv_sp</span>, <span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span>  <span class="va">span</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">yr_lv_sp</span>, <span class="fl">6L</span>, <span class="fl">6L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">filenm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">pums_rds</span>, <span class="st">"/"</span>, <span class="va">yr_lv_sp</span>, <span class="st">".gz"</span><span class="op">)</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">psrccensus</span><span class="fu">:::</span><span class="fu"><a href="../reference/fetch_ftp.html">fetch_ftp</a></span><span class="op">(</span><span class="va">span</span>, <span class="va">dyear</span>, <span class="va">level</span><span class="op">)</span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">dt</span>, file <span class="op">=</span> <span class="va">filenm</span>, compress <span class="op">=</span> <span class="st">"gz"</span><span class="op">)</span>    <span class="co"># export compressed .rds</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">arg_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>dyear<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2005</span><span class="op">:</span><span class="fl">2019</span>,<span class="fl">2021</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span>,</span>
<span>                          level<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"p"</span>,<span class="st">"h"</span><span class="op">)</span>, </span>
<span>                          span<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Not using (discontinued) 3-yr</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/transpose.html" class="external-link">transpose</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">paste0</span>, collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"0[5-8]\\w5$"</span>, <span class="va">.</span>, invert<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span>        <span class="co"># Starting 5-yr ACS data with 2005-2009</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">arg_vector</span>, <span class="va">make_offline_pums</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="utilize-the-local-file-option">Utilize the local file option<a class="anchor" aria-label="anchor" href="#utilize-the-local-file-option"></a>
</h3>
<p>Once the prepared files are in place–i.e. both the household file and
the person file for a given year &amp; span–it is straightforward to
reference the directory location in the <code>get_psrc_pums(dir=)</code>
call:</p>
<pre class="using"><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://psrc.github.io/psrccensus/">psrccensus</a></span><span class="op">)</span></span>
<span><span class="va">pums_rds</span> <span class="op">&lt;-</span> <span class="st">"your/desired/storage/directory/path"</span></span>
<span></span>
<span><span class="va">my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_psrc_pums.html">get_psrc_pums</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2022</span>, <span class="st">"p"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HINCP"</span>, <span class="st">"SOC2"</span><span class="op">)</span>, dir <span class="op">=</span> <span class="va">pums_rds</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="use-cases-and-considerations">Use cases and considerations<a class="anchor" aria-label="anchor" href="#use-cases-and-considerations"></a>
</h3>
<p>Loading from these files can improve speed significantly, so you may
want to consider it if you are working with PUMS a lot or are building a
server-hosted app that involves calling <code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code>.
The downside is the required file management, e.g. when the Census
Bureau releases a new dataset, you’ll need to be sure the corresponding
.gz file is created before the option will work for that data year.</p>
<p>To increase speed for a server-hosted app, you may want to consider
going a step farther and carry through all the potential statistical
analyses, so the app will draw from stored summary results rather than
call any <code>psrccensus</code> functions itself. Although this
involves an upfront investment of thought, time, and data processing, it
will pay off in dramatically lower response times for app users.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Craig Helmann, Christy Lam, Polina Butrina, Suzanne Childress, Michael Jensen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
