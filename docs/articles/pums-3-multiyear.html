<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Suggestions for applying PUMS functions longitudinally
">
<title>PUMS 3: Script multiyear functions • psrccensus</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="PUMS 3: Script multiyear functions">
<meta property="og:description" content="Suggestions for applying PUMS functions longitudinally
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psrccensus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/psrccensus.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/calculate-reliability-moe-transformed-acs.html">Reliability Measures for ACS data tables</a>
    <a class="dropdown-item" href="../articles/geographic-conversions.html">Census estimates for non-census geographies</a>
    <a class="dropdown-item" href="../articles/get-data.html">Get Data</a>
    <a class="dropdown-item" href="../articles/pums-1-basics.html">PUMS 1: Calculate basic summaries</a>
    <a class="dropdown-item" href="../articles/pums-2-make-vars.html">PUMS 2: Make your own variables</a>
    <a class="dropdown-item" href="../articles/pums-3-multiyear.html">PUMS 3: Script multiyear functions</a>
    <a class="dropdown-item" href="../articles/pums-4-local-downloads.html">PUMS 4: Download optimization</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>PUMS 3: Script multiyear functions</h1>
            
      
      
      <div class="d-none name"><code>pums-3-multiyear.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="time-the-next-dimension">Time: the next dimension<a class="anchor" aria-label="anchor" href="#time-the-next-dimension"></a>
</h2>
<p>Now that you’ve learned to calculate single-survey results from the
PUMS microdata, what’s to stop you from calculating trends across
multiple surveys? As it turns out, there are a few potholes in that road
to avoid.</p>
<div class="section level3">
<h3 id="hint-1---be-mindful-of-span">Hint #1 - Be mindful of span<a class="anchor" aria-label="anchor" href="#hint-1---be-mindful-of-span"></a>
</h3>
<p>This item relates to confidence levels: the Census Bureau strongly
advises against drawing comparisons from surveys with overlapping spans
(e.g. 2015-19 &amp; 2016-20 5yr data), since identical observations are
present in both surveys, which means you may underestimate change or
overestimate certainty. 5-year data are best if 5-year intervals answer
the need; to get annual trends, you’ll need to use the 1yr data (which
involves more uncertainty). Remember to use Z-scores to determine
whether trend values can be considered statistically distinct.</p>
</div>
<div class="section level3">
<h3 id="hint-2---compare-data-dictionaries">Hint #2 - Compare data dictionaries<a class="anchor" aria-label="anchor" href="#hint-2---compare-data-dictionaries"></a>
</h3>
<p>Although they may seem consistent at first blush, many PUMS variable
codes, values, and labels have changed during the course of the program.
If you plan to compare data across multiple surveys, you’ll either want
to confirm the variables of interest have remained consistent, or write
your code to handle the differences among them. In some cases, the way
data were reported–or the way the question was asked–might preclude
accurate multi-year comparisons at your desired level of detail.</p>
</div>
<div class="section level3">
<h3 id="hint-3---use-real-dollar-variables">Hint #3 - Use real dollar variables<a class="anchor" aria-label="anchor" href="#hint-3---use-real-dollar-variables"></a>
</h3>
<p>Due to inflation, the value of a dollar declines over time; to
achieve a true multi-year comparison of price or income variables, these
must be adjusted to real terms–i.e., adjusted to reflect a common
reference year dollar value. This involves multiplying by a ratio (known
as a ‘deflator’) of the relevant annual values of a price index,
generally the Personal Consumption Expenditures (PCE) Index, as it is
updated to remain valid across years. Prior to running the statistical
functions, use the <strong>psrccensus</strong> function
<code><a href="../reference/real_dollars.html">real_dollars()</a></code> on your survey data object to create real
versions of your monetary variables. This leaves the original variables
intact; the real versions will be suffixed with the reference year you
specify (i.e., if converting HINCP in the 2015 survey to 2020 values,
the new variable will be HINCP2020). Note you will need a <a href="http://sboysel.github.io/fredr/articles/fredr.html#authentication" class="external-link">St. Louis
Federal Reserve (FRED) API key</a>.</p>
</div>
<div class="section level3">
<h3 id="hint-4---minimize-downloads">Hint #4 - Minimize downloads<a class="anchor" aria-label="anchor" href="#hint-4---minimize-downloads"></a>
</h3>
<p>While writing multi-year functions, keep in mind
<code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code> downloads and combines all possible
variables before returning those you requested, so it’s efficient to
group operations on the same survey (year/span) rather than to call
<code><a href="../reference/get_psrc_pums.html">get_psrc_pums()</a></code> separately for each desired measure. We
recommend combining your data retrieval, manipulation and summarization
operations for a single year into a function, which you can then apply
across multiple surveys. This approach requires only as many downloads
as you have surveys–resulting in faster operations and lower demand on
memory.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://psrc.github.io/psrccensus/">psrccensus</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build a single year function first</span></span>
<span><span class="co"># -- it can include as many individual stat analyses as needed (see list items at end)</span></span>
<span><span class="co"># -- notice `real_dollars()` creates the variable HINCP2020 later used for median statistic</span></span>
<span></span>
<span><span class="va">pums_singleyear</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dyear</span>, <span class="va">span</span><span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">hh_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_psrc_pums.html">get_psrc_pums</a></span><span class="op">(</span><span class="va">span</span>, <span class="va">dyear</span>, <span class="st">"h"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HINCP"</span>,<span class="st">"AGEP"</span>,<span class="st">"HRACE"</span>,<span class="st">"LNGI"</span>,<span class="st">"SCHL"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">hh_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/real_dollars.html">real_dollars</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ed_attain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"(Bach|Mast|Prof|Doct)"</span>, <span class="va">SCHL</span><span class="op">)</span>  <span class="op">~</span> <span class="st">"Bachelor's degree or higher"</span>,</span>
<span>                                 <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">SCHL</span><span class="op">)</span>                          <span class="op">~</span> <span class="st">"Less than a Bachelor's degree"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    lmtd_engl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^No one"</span>, <span class="va">LNGI</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Limited English proficiency"</span>,</span>
<span>                                 <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LNGI</span><span class="op">)</span>           <span class="op">~</span> <span class="st">"English proficient"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HRACE"</span>,<span class="st">"lmtd_engl"</span>,<span class="st">"ed_attain"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">singleyr_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">singleyr_rs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pums_bulk_stat.html">pums_bulk_stat</a></span><span class="op">(</span><span class="va">hh_df</span>, <span class="st">"count"</span>, group_var_list<span class="op">=</span><span class="va">dvars</span>, incl_na<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">singleyr_rs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pums_bulk_stat.html">pums_bulk_stat</a></span><span class="op">(</span><span class="va">hh_df</span>, <span class="st">"median"</span>, <span class="st">"HINCP2020"</span>, <span class="va">dvars</span>, incl_na<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># singleyr_rs[[3]] &lt;- ...</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">singleyr_rs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Multiyear function runs the single-year function across years and combines results</span></span>
<span><span class="va">pums_multiyear</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dyears</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">multiyear_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">dyears</span>, <span class="va">pums_singleyear</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">as.vector</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="va"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">multiyear_rs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">pums_multiyear</span><span class="op">(</span><span class="fl">2015</span><span class="op">:</span><span class="fl">2019</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Craig Helmann, Christy Lam, Polina Butrina, Suzanne Childress, Michael Jensen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
